"use strict";(self.webpackChunkelemental_docs=self.webpackChunkelemental_docs||[]).push([[489],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>d});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var c=a.createContext({}),i=function(e){var n=a.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=i(e.components);return a.createElement(c.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,c=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=i(t),d=r,k=m["".concat(c,".").concat(d)]||m[d]||u[d]||l;return t?a.createElement(k,o(o({ref:n},p),{},{components:t})):a.createElement(k,o({ref:n},p))}));function d(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,o=new Array(l);o[0]=m;var s={};for(var c in n)hasOwnProperty.call(n,c)&&(s[c]=n[c]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var i=2;i<l;i++)o[i]=t[i];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},1489:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>k,frontMatter:()=>l,metadata:()=>s,toc:()=>i});var a=t(7462),r=(t(7294),t(3905));const l={sidebar_label:"Backup",title:""},o=void 0,s={unversionedId:"backup",id:"backup",title:"",description:"Redirecting to https://elemental.docs.rancher.com",source:"@site/docs/backup.md",sourceDirName:".",slug:"/backup",permalink:"/elemental/backup",draft:!1,tags:[],version:"current",frontMatter:{sidebar_label:"Backup",title:""},sidebar:"elemental",previous:{title:"Inventory Management",permalink:"/elemental/inventory-management"},next:{title:"Restore",permalink:"/elemental/restore"}},c={},i=[{value:"Install rancher-backup operator for Rancher",id:"install-rancher-backup-operator-for-rancher",level:2},{value:"Backup Elemental with rancher-backup operator (only for Rancher v2.7 and below)",id:"backup-elemental-with-rancher-backup-operator-only-for-rancher-v27-and-below",level:2}],p=e=>function(n){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),(0,r.kt)("div",n)},u=p("Tabs"),m=p("TabItem"),d={toc:i};function k(e){let{components:n,...t}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("head",null,(0,r.kt)("meta",{charset:"utf-8"}),(0,r.kt)("title",null,"Redirecting to https://elemental.docs.rancher.com"),(0,r.kt)("meta",{"http-equiv":"refresh",content:"0; URL=https://elemental.docs.rancher.com/"}),(0,r.kt)("link",{rel:"canonical",href:"https://elemental.docs.rancher.com/"})),(0,r.kt)("h1",{id:"backup"},"Backup"),(0,r.kt)("p",null,"Follow this guide to create backup for Elemental configuration installed together with Rancher."),(0,r.kt)("h2",{id:"install-rancher-backup-operator-for-rancher"},"Install rancher-backup operator for Rancher"),(0,r.kt)("p",null,"Go to official ",(0,r.kt)("a",{parentName:"p",href:"https://docs.ranchermanager.rancher.io/how-to-guides/new-user-guides/backup-restore-and-disaster-recovery/back-up-rancher"},"Rancher documentation")," and install rancher-bakup operator from there."),(0,r.kt)("admonition",{title:"warning",type:"warning"},(0,r.kt)("p",{parentName:"admonition"},"For Rancher v2.7 and below it is needed to edit ",(0,r.kt)("inlineCode",{parentName:"p"},"ResourceSet")," for rancher-backup operator.\nFor Rancher v2.7.1+ backup will be done automatically by rancher-backup operator and no further operation are needed.")),(0,r.kt)("h2",{id:"backup-elemental-with-rancher-backup-operator-only-for-rancher-v27-and-below"},"Backup Elemental with rancher-backup operator (only for Rancher v2.7 and below)"),(0,r.kt)("p",null,"Fetch ",(0,r.kt)("inlineCode",{parentName:"p"},"rancher-resource-set")," object from Kubernetes cluster"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell",metastring:"showLineNumbers",showLineNumbers:!0},"kubectl get ResourceSet rancher-resource-set -o yaml > rancher-resource-set.yaml\n")),(0,r.kt)(u,{mdxType:"Tabs"},(0,r.kt)(m,{value:"manualEdit",label:"Manually editing the resource set yaml",mdxType:"TabItem"},(0,r.kt)("p",null,"At the end of ",(0,r.kt)("inlineCode",{parentName:"p"},"rancher-resource-set.yaml")," file add the definition of Elemental resources"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml",metastring:"showLineNumbers",showLineNumbers:!0},'- apiVersion: apiextensions.k8s.io/v1\nkindsRegexp: .\nresourceNameRegexp: elemental.cattle.io$\n- apiVersion: apps/v1\nkindsRegexp: ^deployments$\nnamespaces:\n- cattle-elemental-system\nresourceNames:\n- elemental-operator\n- apiVersion: rbac.authorization.k8s.io/v1\nkindsRegexp: ^clusterroles$\nresourceNames:\n- elemental-operator\n- apiVersion: rbac.authorization.k8s.io/v1\nkindsRegexp: ^clusterrolebindings$\nresourceNames:\n- elemental-operator\n- apiVersion: v1\nkindsRegexp: ^serviceaccounts$\nnamespaces:\n- cattle-elemental-system\nresourceNames:\n- elemental-operator\n- apiVersion: management.cattle.io/v3\nkindsRegexp: ^globalrole$\nresourceNames:\n- elemental-operator\n- apiVersion: management.cattle.io/v3\nkindsRegexp: ^apiservice$\nresourceNameRegexp: elemental.cattle.io$\n- apiVersion: elemental.cattle.io/v1beta1\nkindsRegexp: .\nnamespaceRegexp: ^cattle-fleet-|^fleet-|^cluster-fleet-\n- apiVersion: rbac.authorization.k8s.io/v1\nkindsRegexp: ^roles$|^rolebindings$\nlabelSelectors:\n  matchExpressions:\n  - key: elemental.cattle.io/managed\n    operator: In\n    values:\n    - "true"\nnamespaceRegexp: ^cattle-fleet-|^fleet-|^cluster-fleet-\n- apiVersion: v1\nkindsRegexp: ^secrets$|^serviceaccounts$\nlabelSelectors:\n  matchExpressions:\n  - key: elemental.cattle.io/managed\n    operator: In\n    values:\n    - "true"\nnamespaceRegexp: ^cattle-fleet-|^fleet-|^cluster-fleet-\n'))),(0,r.kt)(m,{value:"yqMerge",label:"Using yq to auto merge yaml files",mdxType:"TabItem"},(0,r.kt)("p",null,"You can use yq to auto merge ",(0,r.kt)("inlineCode",{parentName:"p"},"rancher-resource-set.yaml")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"elemental-resource-set.yaml"),". Please go and install ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/mikefarah/yq/#install"},"yq v4.x")," version"),(0,r.kt)("p",null,"Create ",(0,r.kt)("inlineCode",{parentName:"p"},"elemental-resource-set.yaml")," file"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml",metastring:"showLineNumbers",showLineNumbers:!0},'apiVersion: resources.cattle.io/v1\nkind: ResourceSet\nmetadata:\n  name: rancher-resource-set\nresourceSelectors:\n- apiVersion: apiextensions.k8s.io/v1\n  kindsRegexp: .\n  resourceNameRegexp: elemental.cattle.io$\n- apiVersion: apps/v1\n  kindsRegexp: ^deployments$\n  namespaces:\n  - cattle-elemental-system\n  resourceNames:\n  - elemental-operator\n- apiVersion: rbac.authorization.k8s.io/v1\n  kindsRegexp: ^clusterroles$\n  resourceNames:\n  - elemental-operator\n- apiVersion: rbac.authorization.k8s.io/v1\n  kindsRegexp: ^clusterrolebindings$\n  resourceNames:\n  - elemental-operator\n- apiVersion: v1\n  kindsRegexp: ^serviceaccounts$\n  namespaces:\n  - cattle-elemental-system\n  resourceNames:\n  - elemental-operator\n- apiVersion: management.cattle.io/v3\n  kindsRegexp: ^globalrole$\n  resourceNames:\n  - elemental-operator\n- apiVersion: management.cattle.io/v3\n  kindsRegexp: ^apiservice$\n  resourceNameRegexp: elemental.cattle.io$\n- apiVersion: elemental.cattle.io/v1beta1\n  kindsRegexp: .\n  namespaceRegexp: ^cattle-fleet-|^fleet-|^cluster-fleet-\n- apiVersion: rbac.authorization.k8s.io/v1\n  kindsRegexp: ^roles$|^rolebindings$\n  labelSelectors:\n    matchExpressions:\n    - key: elemental.cattle.io/managed\n      operator: In\n      values:\n      - "true"\n  namespaceRegexp: ^cattle-fleet-|^fleet-|^cluster-fleet-\n- apiVersion: v1\n  kindsRegexp: ^secrets$|^serviceaccounts$\n  labelSelectors:\n    matchExpressions:\n    - key: elemental.cattle.io/managed\n      operator: In\n      values:\n      - "true"\n  namespaceRegexp: ^cattle-fleet-|^fleet-|^cluster-fleet-\n')),(0,r.kt)("p",null,"To merge both files, use ",(0,r.kt)("inlineCode",{parentName:"p"},"yq")," command"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell",metastring:"showLineNumbers",showLineNumbers:!0},"yq ea --inplace '. as $item ireduce ({}; . *+ $item )' rancher-resource-set.yaml elemental-resource-set.yaml\n")))),(0,r.kt)("p",null,"Then apply changes to Kubernetes cluster"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell",metastring:"showLineNumbers",showLineNumbers:!0},"kubectl apply -f rancher-resource-set.yaml\n")),(0,r.kt)("p",null,"Create ",(0,r.kt)("inlineCode",{parentName:"p"},"elemental-backup.yaml")," file which allows backup with creating Backup object"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml",metastring:"showLineNumbers",showLineNumbers:!0},'apiVersion: resources.cattle.io/v1\nkind: Backup\nmetadata:\n  name: elemental-backup\nspec:\n  resourceSetName: rancher-resource-set\n  schedule: "10 3 * * *"\n  retentionCount: 10\n')),(0,r.kt)("p",null,"Then apply changes to Kubernetes cluster"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell",metastring:"showLineNumbers",showLineNumbers:!0},"kubectl apply -f elemental-backup.yaml\n")),(0,r.kt)("p",null,"Check logs from rancher-backup operator"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell",metastring:"showLineNumbers",showLineNumbers:!0},"kubectl logs -n cattle-resources-system -l app.kubernetes.io/name=rancher-backup -f\n")),(0,r.kt)("p",null,"Verify if backup file was created on Persistent Volume."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell",metastring:"showLineNumbers",showLineNumbers:!0},"...\nINFO[2022/10/17 07:45:04] Finding files starting with /var/lib/backups/rancher-backup-430169aa-edde-4a61-85e8-858f625a755b*.tar.gz \nINFO[2022/10/17 07:45:04] File rancher-backup-430169aa-edde-4a61-85e8-858f625a755b-2022-10-17T05-15-00Z.tar.gz was created at 2022-10-17 0\n...\n")))}k.isMDXComponent=!0}}]);